<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music player</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
        integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />


    <link rel="stylesheet" href="./assets/css/styles.css">
</head>

<body>
    <div class="player">
        <!-- Dashboard -->
        <div class="dashboard">
            <header>
                <h4>Now playing:</h4>
                <h2>Enjoy today</h2>
            </header>

            <!-- CD -->
            <div class="cd">
                <div class="cd-thumb"></div>
            </div>

            <!-- Controls -->
            <div class="control">
                <span class="btn btn-repeat">
                    <i class="fa-solid fa-rotate-right "></i>
                </span>
                <span class="btn btn-prev">
                    <i class="fa-solid fa-backward-step"></i>
                </span>
                <span class="btn btn-toggle-play">
                    <i class="fa-solid fa-pause icon-pause"></i>
                    <i class="fa-solid fa-play icon-play"></i>
                </span>
                <span class="btn btn-next">
                    <i class="fa-solid fa-forward-step"></i>
                </span>
                <span class="btn btn-random">
                    <i class="fa-solid fa-shuffle"></i>
                </span>
            </div>

            <!-- Progress -->
            <input type="range" id="progress" class="progress" value="0" step="1" min="0" max="100">

            <audio id="radio" src=""></audio>
        </div>

        <!-- Playlist -->
        <div class="playlist">

        </div>
    </div>

    <script>
        /**
         * 1. Render songs -> ok
         * 2. Scroll top -> ok
         * 3. Play/ Pause/ seek
         * 4. CD rotate
         * 5. Next/ prev
         * 6. Random 
         * 7. Next/ Repeat when ended
         * 8. Active song
         * 9. Scroll active song into view
         * 10. Play song when click
         */
        const $ = document.querySelector.bind(document);
        const $$ = document.querySelectorAll.bind(document);

        const player = $('.player');
        const playlist = $('.playlist');
        const heading = $('header h2');
        const cdThumb = $('.cd-thumb');
        const cd = $('.cd');
        const audio = $('audio');
        const playBtn = $('.btn-toggle-play')
        const progress = $('#progress');
        const prevBtn = $('.btn-prev');
        const nextBtn = $('.btn-next');
        const randomBtn = $('.btn-random');
        const repeatBtn = $('.btn-repeat');

        const app = {
            currentIndex: 0,
            isPLaying: false,
            isRandom: false,
            isRepeat: false,
            songs: [
                {
                    name: "Enjoy today",
                    singer: "Shizuko Mori",
                    path: "./assets/music/enjoy-today.mp3",
                    image: "./assets/img/enjoy-today.jpeg"
                },
                {
                    name: "At My Worst",
                    singer: "Pink Sweat$",
                    path: "./assets/music/at_my_worst.mp3",
                    image: "./assets/img/at_my_worst.jpeg"
                },
                {
                    name: "Livin' On Love",
                    singer: "Alan Jackson",
                    path: "./assets/music/living-on-love.mp3",
                    image: "./assets/img/living-on-love.jpeg"
                },
                {
                    name: "17",
                    singer: "Wildflowers",
                    path: "./assets/music/17.mp3",
                    image: "./assets/img/17.jpeg"
                },
                {
                    name: "Little Do You Know",
                    singer: "Alex & Sierra",
                    path: "./assets/music/little-do-you-know.mp3",
                    image: "./assets/img/little-do-you-know.jpeg"
                },
                {
                    name: "Why not me",
                    singer: "Enrique Iglesias",
                    path: "./assets/music/why-not-me.mp3",
                    image: "./assets/img/why-not-me.jpg"
                },
                {
                    name: "Photograph",
                    singer: "Ed Sheeran",
                    path: "./assets/music/photograph.mp3",
                    image: "./assets/img/photograph.jpeg"
                },
                {
                    name: "Espresso",
                    singer: "Sabrina Carpenter ",
                    path: "./assets/music/espresso.mp3",
                    image: "./assets/img/espresso.jpeg"
                },
                {
                    name: "Fortnight",
                    singer: "Taylor Swift ",
                    path: "./assets/music/fortnight.mp3",
                    image: "./assets/img/fortnight.jpg"
                },
                {
                    name: "SeÃ±orita",
                    singer: "Shawn Mendes, Camila Cabello",
                    path: "./assets/music/senorita.mp3",
                    image: "./assets/img/senorita.jpeg"
                }
            ],
            render: function () {
                const htmls = this.songs.map((song, index) => {
                    return (`
                       <div class="song ${this.currentIndex === index ? 'active' : ''}" data-index=${index}>
                        <div class="thumb" style="background-image: url(${song.image});"></div>
                        <div class="body">
                            <h3 class="title">${song.name}</h3>
                            <p class="author">${song.singer}</p>
                        </div>
                        <div class="option">
                            <i class="fa-solid fa-ellipsis"></i>
                        </div>
                    </div>
                    
                    `)
                })

                playlist.innerHTML = htmls.join('')
            },
            defineProperties: function () {
                Object.defineProperty(this, 'currentSong', {
                    get: function () {
                        return this.songs[this.currentIndex];
                    }
                });
            },
            handerEvents: function () {
                const cdWidth = cd.offsetWidth;

                const cdThumbAnimate = cdThumb.animate([
                    { transform: 'rotate(360deg)' }
                ], {
                    duration: 10000,
                    iterations: Infinity
                });

                cdThumbAnimate.pause();

                document.onscroll = function () {
                    const scrollTop = window.scrollY || document.documentElement.scrollTop;
                    const newCdWidth = cdWidth - scrollTop;

                    cd.style.width = newCdWidth > 0 ? newCdWidth + "px" : 0
                }

                playBtn.onclick = () => {
                    if (this.isPLaying) {
                        audio.pause();
                    } else {
                        audio.play();
                    }

                }

                audio.onplay = () => {
                    this.isPLaying = true;
                    player.classList.add('playing');
                    cdThumbAnimate.play();
                }

                audio.onpause = () => {
                    this.isPLaying = false;
                    player.classList.remove('playing')
                    cdThumbAnimate.pause();
                }

                audio.ontimeupdate = () => {
                    if (audio.duration) {
                        const progressPercent = Math.floor(audio.currentTime / audio.duration * 100);
                        progress.value = progressPercent
                    }
                }

                progress.oninput = function (e) {
                    const seekTime = audio.duration / 100 * e.target.value;
                    audio.currentTime = seekTime;
                }

                nextBtn.onclick = () => {
                    if (this.isRandom) {
                        this.playRandomSongs();
                    } else {
                        this.nextSong();
                    }
                    audio.play();
                    this.render();
                    this.scrollToActiveSong()
                }

                prevBtn.onclick = () => {
                    if (this.isRandom) {
                        this.playRandomSongs();
                    } else {
                        this.prevSong();
                    }
                    audio.play();
                    this.render();
                    this.scrollToActiveSong();

                }

                randomBtn.onclick = () => {
                    this.isRandom = !this.isRandom
                    randomBtn.classList.toggle('active', this.isRandom)
                }

                repeatBtn.onclick = () => {
                    this.isRepeat = !this.isRepeat
                    repeatBtn.classList.toggle('active', this.isRepeat)
                }

                audio.onended = () => {
                    if (this.isRepeat) {
                        audio.play()
                    } else {
                        nextBtn.click();
                    }
                }

                playlist.onclick = (e) => {
                    const songNode = e.target.closest('.song:not(.active)');
                    if (songNode || e.target.closest('option')) {
                        if (songNode) {
                            this.currentIndex = Number(songNode.dataset.index);
                            this.loadCurrentSong();
                            this.render();
                            audio.play();
                        }
                    }
                }

            },
            loadCurrentSong: function () {
                heading.textContent = this.currentSong.name;
                cdThumb.style.backgroundImage = `url('${this.currentSong.image}')`;
                audio.src = this.currentSong.path

            },
            nextSong: function () {
                this.currentIndex++;
                if (this.currentIndex >= this.songs.length) {
                    this.currentIndex = 0;
                }
                this.loadCurrentSong();
            },
            prevSong: function () {
                this.currentIndex--;
                if (this.currentIndex < 0) {
                    this.currentIndex = this.songs.length - 1;
                }
                this.loadCurrentSong();
            },
            playRandomSongs: function () {
                let newIndex;
                do {
                    newIndex = Math.floor(Math.random() * this.songs.length);
                } while (newIndex === this.currentIndex)

                this.currentIndex = newIndex;
                this.loadCurrentSong();
            },
            scrollToActiveSong: function () {

                $('.song.active').scrollIntoView({
                    behavior: 'smooth',
                    block: 'end'
                })
            },
            start: function () {
                this.defineProperties()

                this.handerEvents()

                this.loadCurrentSong()

                this.render()
            },


        }

        app.start()
    </script>
</body>

</html>